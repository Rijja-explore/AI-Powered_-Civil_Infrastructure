import React, { useState, useEffect } from 'react';
import { 
  BarChart, Bar, LineChart, Line, PieChart, Pie, ScatterChart, Scatter, 
  RadarChart, Radar, PolarGrid, PolarAngleAxis, PolarRadiusAxis,
  XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Cell 
} from 'recharts';
import { TrendingUp, AlertTriangle, BarChart3, Target, Wind, Droplet, Zap, Leaf, Shield, Activity, CheckCircle, Download, Database, AlertCircle } from 'lucide-react';

const Analytics = () => {
  // State Management
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [datasetStats, setDatasetStats] = useState(null);
  const [crackAnalytics, setCrackAnalytics] = useState(null);
  const [vegetationAnalytics, setVegetationAnalytics] = useState(null);
  const [hiddenDamageData, setHiddenDamageData] = useState(null);
  const [currentImageData, setCurrentImageData] = useState(null);
  const [statisticalTests, setStatisticalTests] = useState(null);

  // Fetch all analytics data on mount
  useEffect(() => {
    const fetchAnalytics = async () => {
      setLoading(true);
      setError(null);
      try {
        // Dataset Overview
        const datasetRes = await fetch('http://localhost:5002/api/analytics/dataset');
        const datasetJson = await datasetRes.json();
        setDatasetStats(datasetJson);

        // Hidden Damage Analytics
        const hiddenDamageRes = await fetch('http://localhost:5002/api/analytics/hidden_damage');
        const hiddenDamageJson = await hiddenDamageRes.json();
        setHiddenDamageData(hiddenDamageJson);

        // Current Image Comparison
        const currentImageRes = await fetch('http://localhost:5002/api/analytics/last_image');
        const currentImageJson = await currentImageRes.json();
        setCurrentImageData(currentImageJson);

        // Mock data for crack and vegetation analytics (replace with real endpoints if available)
        setCrackAnalytics({
          severity_distribution: { Critical: 45, Severe: 78, Moderate: 132, Minor: 210 },
          length_histogram: [
            { range: '0-5mm', count: 180 },
            { range: '5-10mm', count: 140 },
            { range: '10-20mm', count: 85 },
            { range: '20-50mm', count: 45 },
            { range: '>50mm', count: 15 }
          ],
          depth_vs_length: [
            { length: 2.3, depth: 0.8, severity: 'Minor' },
            { length: 5.7, depth: 1.5, severity: 'Moderate' },
            { length: 12.4, depth: 3.2, severity: 'Severe' },
            { length: 28.5, depth: 7.8, severity: 'Critical' },
            { length: 8.9, depth: 2.1, severity: 'Moderate' },
            { length: 15.3, depth: 4.5, severity: 'Severe' },
            { length: 32.7, depth: 9.2, severity: 'Critical' }
          ]
        });

        setVegetationAnalytics({
          coverage_distribution: { Low: 120, Medium: 85, High: 48 },
          type_distribution: { Moss: 95, Algae: 78, Vines: 45, Roots: 35 },
          severity_vs_health: [
            { severity: 1, health: 95 },
            { severity: 3, health: 78 },
            { severity: 5, health: 62 },
            { severity: 7, health: 45 },
            { severity: 9, health: 28 }
          ]
        });

        setStatisticalTests({
          t_test: { test: 'T-Test (Current vs Dataset)', p_value: 0.0342, significant: true },
          chi_square: { test: 'Chi-Square (Damage Categories)', p_value: 0.0089, significant: true },
          anova: { test: 'ANOVA (Severity Groups)', p_value: 0.0012, significant: true },
          regression: { test: 'Linear Regression (Crack Length vs Depth)', r_squared: 0.87, p_value: 0.0001, equation: 'Depth = 0.28 * Length + 0.34' }
        });

        setLoading(false);
      } catch (err) {
        console.error('Error fetching analytics:', err);
        setError('Failed to load analytics data. Ensure backend is running.');
        setLoading(false
    }
  ];

  const radarConfig = {
    data: envRadarData,
    xField: 'metric',
    yField: 'value',
    appendPadding: [15, 15, 15, 15],
    color: '#3b82f6',
    point: { size: 3, shape: 'circle' },
    smooth: true
  };

  // Crack Details Table
  const damageMetrics = [
    {
      label: 'Critical Issues',
      value: crackData.statistics?.severity_distribution?.Critical || 0,
      color: '#dc2626'
    },
    {
      label: 'Severe Issues',
      value: crackData.statistics?.severity_distribution?.Severe || 0,
      color: '#ea580c'
    },
    {
      label: 'Moderate Issues',
      value: crackData.statistics?.severity_distribution?.Moderate || 0,
      color: '#ca8a04'
    },
    {
      label: 'Minor Issues',
      value: crackData.statistics?.severity_distribution?.Minor || 0,
      color: '#16a34a'
    }
  ];

  return (
    <div className="content-area">
      {/* Header */}
      <div className="card" style={{ marginBottom: '2rem' }}>
        <div className="card-header">
          <h2 style={{ margin: 0, display: 'flex', alignItems: 'center', gap: '0.6rem' }}>
            <BarChart3 size={28} />
            ðŸ“Š Comprehensive Analytics Dashboard
          </h2>
          <p style={{ margin: '0.25rem 0 0 0', color: 'var(--secondary)', fontSize: '0.875rem' }}>
            Project-specific metrics: structural damage, material analysis, environmental impact & deterioration forecasting
          </p>
        </div>
      </div>

      {/* KPI Cards */}
      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1.5rem', marginBottom: '2rem' }}>
        {kpiMetrics.map((metric, idx) => (
          <div key={idx} style={{ background: metric.gradient, padding: '1.5rem', borderRadius: 'var(--border-radius)', border: `1px solid ${metric.color}20` }}>
            <div style={{ fontSize: '0.75rem', color: 'var(--secondary)', fontWeight: '600', marginBottom: '0.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
              <metric.icon size={16} /> {metric.label}
            </div>
            <div style={{ fontSize: '2rem', fontWeight: '700', color: metric.color }}>
              {metric.value}
            </div>
          </div>
        ))}
      </div>

      {/* Charts Grid */}
      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(500px, 1fr))', gap: '2rem', marginBottom: '2rem' }}>
        {/* Severity Distribution */}
        <div className="card">
          <div className="card-header">
            <h3 style={{ margin: 0, display: 'flex', alignItems: 'center', gap: '0.6rem' }}>
              <AlertTriangle size={20} />
              Damage Severity Distribution
            </h3>
          </div>
          <div className="card-body" style={{ height: '300px' }}>
            {severityConfig ? (
              <Pie {...severityConfig} />
            ) : (
              <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '100%', color: 'var(--secondary)' }}>
                No damage severity data
              </div>
            )}
          </div>
        </div>

        {/* Environmental Impact */}
        <div className="card">
          <div className="card-header">
            <h3 style={{ margin: 0, display: 'flex', alignItems: 'center', gap: '0.6rem' }}>
              <Wind size={20} />
              Environmental Impact Profile
            </h3>
          </div>
          <div className="card-body" style={{ height: '300px' }}>
            <Radar {...radarConfig} />
          </div>
        </div>
      </div>

      {/* Second Row Charts */}
      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(500px, 1fr))', gap: '2rem', marginBottom: '2rem' }}>
        {/* Material Composition */}
        <div className="card">
          <div className="card-header">
            <h3 style={{ margin: 0, display: 'flex', alignItems: 'center', gap: '0.6rem' }}>
              <Target size={20} />
              Material Composition Analysis
            </h3>
          </div>
          <div className="card-body" style={{ height: '300px' }}>
            {materialConfig ? (
              <Column {...materialConfig} />
            ) : (
              <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '100%', color: 'var(--secondary)' }}>
                No material data
              </div>
            )}
          </div>
        </div>

        {/* Damage Breakdown */}
        <div className="card">
          <div className="card-header">
            <h3 style={{ margin: 0, display: 'flex', alignItems: 'center', gap: '0.6rem' }}>
              <BarChart3 size={20} />
              Damage Category Breakdown
            </h3>
          </div>
          <div className="card-body">
            <div style={{ display: 'grid', gap: '1rem' }}>
              {damageMetrics.map((metric, idx) => (
                <div key={idx} style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '1rem', background: 'var(--light)', borderRadius: 'var(--border-radius)', border: '1px solid var(--glass-border)' }}>
                  <div style={{ fontSize: '0.875rem', fontWeight: '500', color: 'var(--dark)' }}>
                    {metric.label}
                  </div>
                  <div style={{ fontSize: '1.5rem', fontWeight: '700', color: metric.color }}>
                    {metric.value}
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>

      {/* Environmental Summary */}
      <div className="card" style={{ marginBottom: '2rem' }}>
        <div className="card-header">
          <h3 style={{ margin: 0, display: 'flex', alignItems: 'center', gap: '0.6rem' }}>
            <Zap size={20} />
            Environmental Impact Summary
          </h3>
        </div>
        <div className="card-body">
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1.5rem' }}>
            <div style={{ padding: '1.5rem', background: 'linear-gradient(135deg, rgba(220, 38, 38, 0.1), rgba(239, 68, 68, 0.1))', borderRadius: 'var(--border-radius)', border: '1px solid rgba(220, 38, 38, 0.2)' }}>
              <div style={{ fontSize: '0.75rem', color: 'var(--secondary)', fontWeight: '600', marginBottom: '0.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                <Wind size={16} /> Carbon Footprint
              </div>
              <div style={{ fontSize: '1.75rem', fontWeight: '700', color: '#dc2626' }}>
                {envData.carbon_footprint_kg?.toFixed(2) || 0} kg COâ‚‚
              </div>
            </div>

            <div style={{ padding: '1.5rem', background: 'linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1))', borderRadius: 'var(--border-radius)', border: '1px solid rgba(59, 130, 246, 0.2)' }}>
              <div style={{ fontSize: '0.75rem', color: 'var(--secondary)', fontWeight: '600', marginBottom: '0.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                <Droplet size={16} /> Water Footprint
              </div>
              <div style={{ fontSize: '1.75rem', fontWeight: '700', color: '#3b82f6' }}>
                {envData.water_footprint_liters?.toFixed(2) || 0} L
              </div>
            </div>

            <div style={{ padding: '1.5rem', background: 'linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(249, 180, 0, 0.1))', borderRadius: 'var(--border-radius)', border: '1px solid rgba(245, 158, 11, 0.2)' }}>
              <div style={{ fontSize: '0.75rem', color: 'var(--secondary)', fontWeight: '600', marginBottom: '0.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                <Zap size={16} /> Energy Consumption
              </div>
              <div style={{ fontSize: '1.75rem', fontWeight: '700', color: '#f59e0b' }}>
                {envData.energy_consumption_kwh?.toFixed(2) || 0} kWh
              </div>
            </div>

            <div style={{ padding: '1.5rem', background: 'linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(22, 163, 74, 0.1))', borderRadius: 'var(--border-radius)', border: '1px solid rgba(34, 197, 94, 0.2)' }}>
              <div style={{ fontSize: '0.75rem', color: 'var(--secondary)', fontWeight: '600', marginBottom: '0.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                <Leaf size={16} /> Eco-Efficiency
              </div>
              <div style={{ fontSize: '1.75rem', fontWeight: '700', color: '#16a34a' }}>
                {(envData.eco_efficiency_rating / 10 * 100)?.toFixed(0) || 0}%
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Key Insights */}
      <div className="card">
        <div className="card-header">
          <h3 style={{ margin: 0, display: 'flex', alignItems: 'center', gap: '0.6rem' }}>
            <CheckCircle size={20} />
            ðŸ’¡ Key Insights & Recommendations
          </h3>
        </div>
        <div className="card-body">
          <div style={{ display: 'grid', gap: '1rem' }}>
            <div style={{ padding: '1rem', background: 'var(--light)', borderRadius: 'var(--border-radius)', border: '1px solid var(--glass-border)', display: 'flex', alignItems: 'flex-start', gap: '1rem' }}>
              <AlertTriangle size={20} style={{ color: '#3b82f6', flexShrink: 0, marginTop: '0.25rem' }} />
              <div>
                <div style={{ fontWeight: '600', color: 'var(--dark)', marginBottom: '0.25rem' }}>Structural Assessment</div>
                <div style={{ fontSize: '0.875rem', color: 'var(--secondary)' }}>
                  {insights.statistical_summary?.structural_health_score > 75 ? 'âœ“ Structure is in excellent condition. Continue regular monitoring.' : 
                   insights.statistical_summary?.structural_health_score > 50 ? 'âš  Structure requires scheduled maintenance within 6-12 months.' : 
                   'âœ— Structure requires immediate inspection and repairs.'}
                </div>
              </div>
            </div>

            <div style={{ padding: '1rem', background: 'var(--light)', borderRadius: 'var(--border-radius)', border: '1px solid var(--glass-border)', display: 'flex', alignItems: 'flex-start', gap: '1rem' }}>
              <Leaf size={20} style={{ color: '#10b981', flexShrink: 0, marginTop: '0.25rem' }} />
              <div>
                <div style={{ fontWeight: '600', color: 'var(--dark)', marginBottom: '0.25rem' }}>Biological Contamination</div>
                <div style={{ fontSize: '0.875rem', color: 'var(--secondary)' }}>
                  {bioData.growth_percentage > 20 ? 'âš ï¸ High biological contamination detected. Recommend cleaning and treatment.' :
                   bioData.growth_percentage > 10 ? 'âš¡ Moderate contamination. Monitor and clean if necessary.' :
                   'âœ“ Minimal biological growth. Maintain current maintenance schedule.'}
                </div>
              </div>
            </div>

            <div style={{ padding: '1rem', background: 'var(--light)', borderRadius: 'var(--border-radius)', border: '1px solid var(--glass-border)', display: 'flex', alignItems: 'flex-start', gap: '1rem' }}>
              <Shield size={20} style={{ color: '#f59e0b', flexShrink: 0, marginTop: '0.25rem' }} />
              <div>
                <div style={{ fontWeight: '600', color: 'var(--dark)', marginBottom: '0.25rem' }}>Environmental Sustainability</div>
                <div style={{ fontSize: '0.875rem', color: 'var(--secondary)' }}>
                  Carbon footprint: {envData.carbon_footprint_kg?.toFixed(2) || 0} kg COâ‚‚. Eco-efficiency rating: {envData.eco_efficiency_rating?.toFixed(1) || 0}/10.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default Analytics;
